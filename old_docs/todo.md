# Retento Documentation Site TODO

## Phase 1: プロジェクトの初期化とtodo.mdの作成
- [x] プロジェクトの初期化
- [x] todo.mdの作成

## Phase 2: デザインシステムとコンテンツ構造の設計
- [x] デザインシステムの設定（カラーパレット、フォント）
- [x] コンテンツ構造の設計（セクション分割）

## Phase 3: ページコンポーネントとUIの実装
- [x] ヒーローセクションの実装
- [x] コンセプトセクションの実装
- [x] UX設計セクションの実装
- [x] 開発ロードマップセクションの実装
- [x] レスポンシブデザインの調整

## Phase 4: 完成したウェブページをユーザーに提供
- [x] 最終確認とプレビュー
- [x] チェックポイントの作成
- [x] ユーザーへの提供

## Phase 5: 紹介ページの改修
- [x] ヘッダーに「ログイン」「登録」ボタンを追加
- [x] ヒーローセクションに「無料で始める」CTAボタンを追加
- [x] ルーティング構造の設計（/, /login, /register, /app）

## Phase 6: バックエンド機能の追加
- [x] web-db-user機能の追加（サーバー、データベース、認証）
- [x] データベーススキーマの設計
- [x] 初期単語データ（1000語サンプル）の準備とインポート

## Phase 7: 認証機能の実装
- [ ] ログインページの実装
- [ ] 登録ページの実装
- [ ] 認証状態管理の実装
- [ ] 保護されたルートの実装

## Phase 8: 学習アプリのコア機能実装
- [x] 学習アプリのメイン画面（/app）の実装
- [x] 問題表示画面の実装（4択問題）
- [x] フィードバック画面の実装（色による正誤判定）
- [x] 自信度入力の実装（ボタン式）
- [x] プログレスバーの実装
- [x] tRPCプロシージャ（セッション開始、回答記録）
- [x] 忘却曲線に基づく復習スケジューリング

## Phase 9: AI連携とテーマ別セッション
- [ ] AIフィードバック生成機能の実装
- [ ] テーマ別セッション生成アルゴリズムの実装
- [ ] 例文と選択肢のAI生成

## バグ修正
- [x] sessionIdがNaNになる問題を修正（createSession関数の戻り値を修正）

## Phase 10: 例文と選択肢のAI生成
- [x] OpenAI APIクライアントの設定
- [x] 例文生成プロンプトの設計
- [x] 選択肢生成プロンプトの設計
- [x] startSessionプロシージャへのAI生成機能の統合
- [x] AI生成失敗時のフォールバック実装
- [ ] 生成された例文と選択肢の品質確認

## Phase 11: キャッシング機能の実装
- [ ] wordsテーブルにキャッシュ用カラムを追加（cachedSentence, cachedChoices）
- [ ] 単語データに対して例文と選択肢を事前生成するスクリプトを作成
- [ ] startSessionプロシージャをキャッシュ優先に変更
- [ ] キャッシュがない場合のみAI生成を実行するフォールバック実装
- [ ] 既存の1000語に対してキャッシュを生成

## Phase 12: UX改善とスワイプ実装
- [x] 9000語の新しいCSVを準備（ユーザーがDB更新済み）
- [ ] 1問ずつ生成・表示する方式に変更（10問一括生成を廃止）
- [x] 自信度選択ボタンを削除
- [x] スワイプ操作で自信度判定（左=自信ない、右=微妙、上=完璧）
- [x] 1画面に収まるUIに調整（縦スクロール不要）
- [x] AI生成のAPI URLを修正（/v1/chat/completionsに変更）

## バグ修正 (Phase 12)
- [x] AI生成のJSONパースエラーを修正（マークダウンコードブロック除去）
- [x] スワイプ対象を問題カードに変更
- [x] スワイプ感度を調整（最小距離80px）
- [x] スワイプアニメーションを実装（指/マウスに追従、回転効果）

## Phase 13: AI生成の完全修正と1問目優先生成
- [x] AI生成のJSONパースエラーを完全修正（max_tokens削除、プロンプト簡略化、ログファイル保存）
- [ ] 1問目を優先生成して即表示
- [ ] 残り9問を1問目に関連性の高い単語で一括生成
- [x] 「下線部の単語の意味を選んでください」表示を削除
- [x] 「カードをスワイプして次へ」表示を削除
- [x] スマホでカードスワイプ時にページがスクロールする問題を解消（touch-action: none）
- [x] スワイプ方向の視覚的フィードバック（三角形矢印、テキスト）
- [x] スワイプ中のカード色変化（赤/オレンジ/緑、しきい値に近づくほど濃く）
- [x] スワイプ中のカード透明度変化（しきい値に近づくほど低く）
- [x] 回答後のテキスト選択を無効化（select-none）
- [x] 回答後の選択肢ボタンのホバーハイライトを無効化（pointer-events-none）

## 将来の機能（初回テスト実装後）
- [ ] バックグラウンド問題補充システム（ユーザーレベルに応じた問題を自動生成）
- [ ] 問題数と利用量監視（必要に応じて生成）

## Phase 14: 全単語のベクトル生成とデータベース保存（後回し）
- [x] wordsテーブルにembeddingカラムを追加
- [ ] OpenAI Embeddings APIを使用して全単語のベクトルを生成（Manus Forgeは非対応のため保留）
- [ ] 生成したベクトルをデータベースに保存
- [ ] ベクトル類似度検索のヘルパー関数を作成

注：Manus ForgeはEmbedding APIをサポートしていないため、ベクトル類似度は後回しにし、まずは品詞・難易度レベルでグルーピングする簡易版で実装

## Phase 15: 問題生成ロジックの再設計（簡易版）
- [x] ユーザーレベルから未出題単語を1つランダム選定
- [x] アクティブリコール対象単語を5つ選定
- [x] 品詞・難易度レベルで関連性の高い単語を4つ選定（ベクトル類似度の代わり）
- [x] 選定した10単語をAIに投げて、順番・例文・選択肢・フィードバックを一括生成

## Phase 16: AIフィードバック生成機能の実装
- [x] 各選択肢ごとのフィードバックをJSON構造に追加
- [x] 正解の場合のフィードバック（なぜ正解か、成り立ち、覚え方、豆知識、140字程度）
- [x] 不正解の場合のフィードバック（なぜ不正解か、その訳ならどんな表現か、140字程度）
- [x] フィードバックをフロントエンドで表示

## Phase 17: 不正解時のUI改善とセッション終了画面
- [ ] 不正解時はどこにスワイプしても✕扱いにする
- [ ] 不正解時の視覚的フィードバックを改善
- [ ] セッション終了画面の実装（正解数、スコア、復習リスト）
- [ ] マーク表示（◎完璧・緑、○微妙・オレンジ、△自信無し・黄、✕不正解・黒）

## Phase 18: AI生成とUI改善
- [x] max_tokens〢20000に設定してAI生成をテスト
- [x] AI生成が成功し、フィードバックが正しく表示されることを確認
- [ ] 外部Embedding APIの統合（OpenAI Embeddings API）
- [ ] 全単語のベクトルを生成してデータベースに保存
- [ ] ベクトル類似度検索のヘルパー関数を実装
- [x] 選択肢を選んだら例文の下に日本語訳を表示
- [x] 例文の上下余白を縮小

## Phase 19: 全単語データの投入とベクトル生成
- [x] 既存の1,200語を削除
- [x] vocabulary_new.csvから9,222語をデータベースに投入
- [ ] 全9,222語のベクトルを生成（約15分）

## Phase 20: プロンプト改善
- [x] AI問題生成プロンプトに「例文中の問題以外の単語は、問題単語より簡単にする」指示を追加

## Phase 21: 問題生成ロジックの修正（5問）
- [x] 1セッション5問に変更
- [x] 未出題単語1つ + アクティブリコール2つ + 関連単語2つ
- [x] ベクトル未生成でもエラーが出ないように仮実装（getRelatedWordsは品詞・難易度で選定）

## Phase 22: ユーザーデータ蓄積の改善
- [x] 「自信無し」を「覚えてない」に変更
- [x] ユーザー単語力スコアの数値化（TOTAL_DIFFICULTY = 17,071,535）
- [x] 計算式の実装（score-helpers.ts）

## Phase 23: セッション終了画面
- [x] 最後の問題後にAIで全体フィードバック生成
- [x] ユーザースコア変化の表示
- [x] 各問題の単語・訳・状況（◎○△✕）表示

## Phase 24: バックグラウンド事前問題作成
- [ ] ユーザーの利用状況に合わせて事前生成

## バグ修正: セッション終了エラー
- [x] 復習単語が不足している場合は関連単語で埋めて5問確保
- [x] セッション結果の記録時にwordフィールドを正しく設定

## セッション終了画面の改善
- [x] デザインを他のページのルールに統一（モノトーン基調、アクセントカラーは控えめ）
- [x] 「ホームに戻る」ボタンを控えめに、「次のセッションへ」ボタンをメインに配置
- [x] 学習アドバイスのmax_tokensを500に増やす
- [x] 学習アドバイスのプロンプトを修正（造詣に富んだクリティカルなフィードバック、140字程度）
- [x] 各単語と問題文、ユーザーの正誤（間違えた場合は何と間違えたか）をAIに与える
- [x] フィードバック生成完了を待たずに終了画面に移行
- [x] フィードバック生成中はスケルトン表示、完了したら表示更新

## セッション終了画面の追加修正
- [x] 学習アドバイスの途切れ問題を調査・修正（ログ追加、max_tokensを2000に増やす）
- [x] ◎○△✕に色を追加（◎=緑、○=オレンジ、△=黄色、✕=赤）
- [x] 「セッション完了」のタイトルとフィールドを削除
- [x] 単語力スコアをトップに配置
- [x] スケルトンを薄い灰色に変更
- [x] セクションに色付きアイコンを追加（今回の学習内容と学習アドバイス）
- [x] 単語力スコアが0→0になっている問題を修正（endSessionで結果を保存してからスコア計算）
- [x] 「次のセッション」ボタンで問題カードが表示されない問題を修正

## バグ修正と機能追加
- [x] 「次のセッション」ボタンで同じ問題が出る問題を修正（sessionDataをクリア）
- [x] スコア表示をAIフィードバック生成を待たずにすぐ算出して表示（calculateSessionScoreとgenerateSessionFeedbackに分離）
- [x] 各ユーザーが新しいセッションを始めたタイミングで、次のセッション用の問題を事前生成（pre_generated_sessionsテーブル、preGenerateNextSession）

## バグ修正: 初回アクセス時のエラー
- [x] 初回アクセス時に「学習可能な単語が見つかりません」エラーが出る問題を調査
- [x] selectWordsForSessionにデバッグログを追加
- [x] 修正を実装（サーバー再起動で解決）

## バグ修正: 初回アクセス時のエラー（再発）
- [x] ブラウザコンソールログを確認してエラーの原因を特定
- [x] サーバーログを確認してAPI呼び出しの状況を確認
- [x] 根本原因を修正（App.tsxの認証チェックとローディング表示を統合）

## バグ修正: 2回目以降のセッションで「問題が見つかりません」エラー
- [x] ユーザーのデータベースレコードを確認
- [x] 事前生成セッションのデータ構造を確認
- [x] 原因を特定：事前生成時にwordIdが含まれていない
- [x] pre-generate-helpers.tsを修正してwordIdを追加

## Phase 25: スコア表示の改善
- [x] 1桁・2桁の場合は小数点以下も含めて有効数字3桁表示
- [x] 小数点以下を小さく表示、下揃え

## Phase 26: 初回ユーザーレベルテスト
- [x] テスト用テーブルの作成（initial_test_questions, user_initial_test_results）
- [x] 30問の適応型テストUI実装
- [x] リアルタイムスコア推定アルゴリズム実装（1-20問目、21-30問目で補正）
- [x] 初期スコアに基づく単語マーキング（完璧・微妙の自動設定）
- [x] 単語力スコア調整アルゴリズム実装
- [x] テスト結果画面の実装
- [ ] 300題の固定問題を難易度別に事前生成（管理者が手動実行）

## Phase 27: プロンプト修正とベクトル生成確認
- [x] 例文生成プロンプトに「問題単語を必ず含める」指示を追加（初回テスト・通常問題両方）
- [x] ベクトル生成の完了状況を確認（プロセス終了済み）

## Phase 28: 1000題の初回テスト問題を並列生成
- [x] 難易度均等に1000単語を選定（939単語）
- [x] バックグラウンドで生成開始（約1時間）
- [ ] 生成完了を確認（後で確認）

## Phase 29: 既存ユーザーへの初回テストバナー
- [x] 初回テスト未完了の既存ユーザーにバナーを表示
- [x] バナーから初回テストページへ誘導

## Phase 30: 5問目後にフィードバック事前生成
- [x] 5問目の選択肅選択直後にフィードバック生成を開始
- [x] 結果画面表示時には既に生成完了している状態にする

## Phase 31: スコア表示と色の修正
- [x] 単語力スコアの小数点以下が正しく表示されるように修正（Math.roundを削除）
- [x] ◎=緑、○=オレンジ、△=赤、✕=黒に色を修正

## Phase 32: スコア差分表示の修正
- [x] スコア差分を有効数字4桁に修正（toPrecision(4)使用）

## Phase 33: 初回テストUIの共通化
- [x] 問題カードコンポーネントを共通化（QuestionCard）
- [x] 説明カードコンポーネントを共通化（FeedbackCard）
- [x] App.tsxで共通コンポーネントを使用
- [x] InitialTest.tsxで共通コンポーネントを使用（スワイプ操作）
- [x] 推定スコアをヘッダーに小さく表示

## Phase 34: 初回テスト出題ロジックの改善
- [x] 推定スコア±50の範囲から1問ずつ動的に問題を選定
- [x] バックエンドにgetNextQuestionプロシージャを追加
- [x] フロントエンドで1問ずつ取得する方式に変更

## Phase 35: 初回テストのバグ修正と機能追加
- [x] 初回テスト問題にAIフィードバックを追加（プロンプト修正、スキーマ更新）
- [x] FeedbackCardで初回テスト用のフィードバックを表示
- [x] 既存の初回テスト問題を削除して再生成（フィードバック付き、939題完了）
- [x] カードの震え問題を/appと同じ描画ロジックに統一（useEffectの依存配列を削除）
- [x] スケルトンの色を灰色に修正（bg-accent→bg-muted）
